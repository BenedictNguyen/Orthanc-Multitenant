<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RIS Tester – Merge Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: #f3f4f6; }
    .card { background: white; border-radius: 12px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
  </style>
</head>
<body class="min-h-screen p-8">
  <div class="max-w-6xl mx-auto space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">RIS Tester – Merge Study Demo</h1>
        <p class="text-slate-600 mt-1">Giao diện test để merge StudyInstanceUID giữa hai Accession (dùng Orthanc PostgreSQL)</p>
      </div>
      <div class="text-sm text-slate-500">
        Backend: <span id="backend-url">http://localhost:5000</span>
      </div>
    </header>

    <!-- Orders / Accessions -->
    <section class="card">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold">Danh sách Accessions (Study-level)</h2>
        <div class="flex gap-2">
          <button id="btn-refresh" class="px-3 py-2 bg-slate-700 text-white rounded hover:opacity-90"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
          <button id="btn-show-logs" class="px-3 py-2 bg-amber-500 text-white rounded hover:opacity-90"><i class="fas fa-file-alt mr-2"></i>Logs</button>
        </div>
      </div>

      <div id="orders-container" class="space-y-2 text-sm"></div>
      <div id="orders-empty" class="text-slate-500 mt-4">Loading...</div>
    </section>

    <!-- Manual Merge panel -->
    <section class="card">
      <h3 class="font-semibold mb-3">Manual Merge (quick)</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="manual-src" placeholder="Accession source (has images)" class="p-3 border rounded" />
        <input id="manual-dst" placeholder="Accession target (no images)" class="p-3 border rounded" />
        <div class="flex items-center gap-3">
          <label class="flex items-center gap-2"><input id="manual-dryrun" type="checkbox" checked /> Dry-run</label>
          <button id="manual-merge" class="px-4 py-2 bg-blue-600 text-white rounded">Merge</button>
          <div id="manual-result" class="text-sm"></div>
        </div>
      </div>
    </section>

    <!-- Logs modal (simple) -->
    <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50">
      <div class="bg-white w-11/12 md:w-3/4 max-h-3/4 overflow-auto p-4 rounded-lg">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold">Merge Logs</h4>
          <button onclick="closeModal()" class="text-slate-600">Close</button>
        </div>
        <pre id="log-content" class="code text-xs"></pre>
      </div>
    </div>

    <footer class="text-center text-sm text-slate-500 mt-6">
      Test environment only — không thao tác DB production.
    </footer>
  </div>

<script>
const API_BASE = location.origin; // expects served from Flask http://localhost:5000

function el(html){ const div = document.createElement('div'); div.innerHTML = html; return div.firstElementChild; }

async function fetchOrders(){
  try {
    document.getElementById('orders-empty').textContent = 'Loading...';
    const res = await fetch(API_BASE + '/api/orders');
    const data = await res.json();
    const container = document.getElementById('orders-container');
    container.innerHTML = '';
    if(!Array.isArray(data) || data.length === 0){
      document.getElementById('orders-empty').textContent = 'Không tìm thấy accessions (study-level).';
      return;
    }
    document.getElementById('orders-empty').textContent = '';
    data.forEach(o=>{
      const node = el(`
        <div class="p-3 border rounded flex items-center justify-between">
          <div>
            <div class="font-medium">${o.accession}</div>
            <div class="text-xs text-slate-500">${o.study_uid ? 'StudyUID: ' + o.study_uid : '<no StudyUID>'}</div>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1 bg-slate-700 text-white rounded text-xs" onclick="fillMerge('${o.accession}')">Use</button>
            <button class="px-3 py-1 bg-indigo-600 text-white rounded text-xs" onclick="openMergeConfirm('${o.accession}')">Merge →</button>
          </div>
        </div>
      `);
      container.appendChild(node);
    });
  } catch (err){
    console.error(err);
    document.getElementById('orders-empty').textContent = 'Lỗi khi load orders: ' + err;
  }
}

function fillMerge(accession){
  document.getElementById('manual-src').value = accession;
}

function openMergeConfirm(srcAcc){
  // open a prompt to pick target
  const target = prompt("Nhập Accession target để merge vào (target):");
  if(!target) return;
  const dry = confirm("Dry-run? (OK = dry-run, Cancel = execute merge)");
  doMerge(srcAcc, target, dry);
}

async function doMerge(src, dst, dry=true){
  const resultEl = document.getElementById('manual-result');
  resultEl.innerHTML = 'Processing...';
  try {
    const res = await fetch(API_BASE + '/api/merge-study', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ accession_source: src, accession_target: dst, dry_run: dry })
    });
    const j = await res.json();
    if(res.ok) {
      if(j.dry_run || j.info || j.status === 'ok') {
        resultEl.innerHTML = `<span style="color:green;">${dry ? 'Dry-run OK' : 'Merged OK'}</span>`;
      } else {
        resultEl.innerHTML = `<span style="color:green;">Merged</span>`;
      }
      // refresh list
      await fetchOrders();
    } else {
      resultEl.innerHTML = `<span style="color:red;">Error: ${j.error || res.status}</span>`;
    }
  } catch (err) {
    resultEl.innerHTML = `<span style="color:red;">Network error: ${err}</span>`;
  }
}

document.getElementById('btn-refresh').addEventListener('click', fetchOrders);
document.getElementById('btn-show-logs').addEventListener('click', async ()=>{
  document.getElementById('modal').classList.remove('hidden');
  try {
    const res = await fetch(API_BASE + '/api/merge-logs');
    const j = await res.json();
    document.getElementById('log-content').textContent = (j.logs || []).join('\n') || 'No logs';
  } catch (e) {
    document.getElementById('log-content').textContent = 'Error loading logs: ' + e;
  }
});
function closeModal(){ document.getElementById('modal').classList.add('hidden'); }

document.getElementById('manual-merge').addEventListener('click', ()=>{
  const src = document.getElementById('manual-src').value.trim();
  const dst = document.getElementById('manual-dst').value.trim();
  const dry = document.getElementById('manual-dryrun').checked;
  if(!src || !dst){ alert('Nhập source và target'); return; }
  doMerge(src,dst,dry);
});

// init
fetchOrders();

</script>
</body>
</html>